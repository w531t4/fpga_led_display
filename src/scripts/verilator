#!/usr/bin/env python3
# SPDX-FileCopyrightText: 2025 Aaron White <w531t4@gmail.com>
# SPDX-License-Identifier: MIT
import os
import sys
from pathlib import Path


def find_verilator() -> str:
    override = os.environ.get("VERILATOR_BIN")
    if override:
        return override
    repo_root = Path(__file__).resolve().parent.parent.parent
    candidate = repo_root / "oss-cad-suite" / "bin" / "verilator"
    if candidate.is_file() and os.access(candidate, os.X_OK):
        return str(candidate)
    return "verilator"


def filter_include_args(args: list[str]) -> list[str]:
    # Drop include directives (-I...) so this wrapper can control include paths.
    filtered: list[str] = []
    skip_next = False
    for arg in args:
        # Remove a trailing path that follows a bare -I.
        if skip_next:
            skip_next = False
            continue
        # Strip both "-I" and "-I<path>" forms to avoid leaking extra includes.
        if arg == "-I":
            skip_next = True
            continue
        if arg.startswith("-I"):
            continue
        filtered.append(arg)
    return filtered


def main() -> None:
    verilator = find_verilator()
    if len(sys.argv) < 2:
        os.execvp(verilator, [])
    # Filter out include args before the existing argv munging.
    args = filter_include_args(sys.argv[1:])
    # last = args[-1]
    # dedup = [arg for arg in args[:-1] if arg != last]
    # dedup.append(last)
    # print(f"{verilator}, {[verilator] + args[:-1]}")
    os.execvp(verilator, [verilator] + args[:-1])


if __name__ == "__main__":
    main()
